<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anushka.ai | Advanced Free AI Agent</title>
    <meta name="description" content="Secure, client-side AI assistant using open APIs.">
    
    <!-- Core Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- NLP & Generative Libraries -->
    <script src="https://unpkg.com/compromise"></script>
    
    <!-- Fix for Tracery: Define 'module' so the script doesn't crash in browser -->
    <script>
        var module = { exports: {} };
    </script>
    <script src="https://unpkg.com/tracery-grammar/tracery.js"></script>
    <script>
        // Ensure global access if Tracery attached itself to module.exports
        if (!window.tracery && module.exports) {
            window.tracery = module.exports;
        }
    </script>
    <script src="https://unpkg.com/tracery-grammar/mods-eng-basic.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rita/2.8.31/rita.min.js"></script>

    <!-- Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#2563eb',
                        dark: '#0f172a',
                        surface: '#1e293b'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
        
        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; line-height: 1.6; }
        .prose h1, .prose h2 { font-weight: bold; margin-top: 1em; color: inherit; }
        .prose ul { list-style: disc; padding-left: 1.2em; }
        .prose a { color: #3b82f6; text-decoration: underline; }
        .prose blockquote { border-left: 4px solid #3b82f6; padding-left: 1em; font-style: italic; color: #94a3b8; }
        .prose pre { background: #0f172a; padding: 0.5em; border-radius: 0.5em; overflow-x: auto; color: #e2e8f0; font-family: monospace; }
        .prose img { border-radius: 0.5rem; margin-top: 0.5rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-dark dark:text-gray-100 transition-colors duration-200 h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="flex-none h-16 bg-white dark:bg-surface border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-tr from-pink-500 to-purple-600 p-2 rounded-full shadow-lg shadow-pink-500/30 transform hover:rotate-12 transition-transform duration-300 flex items-center justify-center w-10 h-10 border-2 border-white dark:border-gray-800">
                <span class="text-lg leading-none select-none">üë∏üèª</span>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight bg-clip-text text-transparent bg-gradient-to-r from-pink-600 to-purple-600 dark:from-pink-400 dark:to-purple-400">Anushka.ai</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">Free API & NLP Engine</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="themeToggle" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition" aria-label="Toggle Theme">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
            <button id="clearHistoryBtn" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition" aria-label="Clear History">
                <i data-lucide="trash-2" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- CHAT CONTAINER -->
    <main id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth relative">
        <div id="messagesArea" class="max-w-3xl mx-auto space-y-6 pb-4">
            <!-- Welcome Message -->
            <div class="flex gap-3 fade-in group">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-pink-500 to-purple-600 flex items-center justify-center flex-shrink-0 text-white shadow-md border border-white dark:border-gray-700 text-sm select-none">
                    üë∏üèª
                </div>
                <div class="flex flex-col items-start max-w-[90%]">
                    <div class="bg-white dark:bg-surface border border-gray-100 dark:border-gray-700 px-4 py-3 rounded-2xl rounded-tl-none shadow-sm text-sm md:text-base">
                        <p class="font-semibold mb-2">Anushka is Online.</p>
                        <p class="mb-2">Hello, I am Anushka,I have been upgraded with global databases and NLP processing capabilities.</p>
                        <p class="text-xs font-bold uppercase text-gray-400 mb-2">Try these new tools:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                            <code class="cmd-btn" onclick="app.setInput('@wiki Quantum Computing')">@wiki Quantum Computing</code>
                            <code class="cmd-btn" onclick="app.setInput('@image Cyberpunk City')">@image Cyberpunk City</code>
                            <code class="cmd-btn" onclick="app.setInput('@country India')">@country India</code>
                            <code class="cmd-btn" onclick="app.setInput('@nature Monarch Butterfly')">@nature Monarch Butterfly</code>
                            <code class="cmd-btn" onclick="app.setInput('@story fantasy')">@story fantasy</code>
                            <code class="cmd-btn" onclick="app.setInput('@math derivative of x^2')">@math derivative of x^2</code>
                            <code class="cmd-btn" onclick="app.setInput('@analyze This sentence has verbs.')">@analyze [Text]</code>
                            <code class="cmd-btn" onclick="app.setInput('@chem Caffeine')">@chem Caffeine</code>
                        </div>
                    </div>
                    <!-- Actions for Welcome Msg -->
                    <div class="flex gap-2 mt-1 opacity-0 group-hover:opacity-100 transition-opacity pl-1">
                        <button class="text-gray-400 hover:text-blue-500 transition p-1" onclick="app.ui.actionCopy('Anushka is online...')" title="Copy"><i data-lucide="copy" class="w-3 h-3"></i></button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden max-w-3xl mx-auto mt-4 px-12">
            <div class="flex gap-1">
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-100"></div>
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-200"></div>
            </div>
        </div>
        <div id="scrollAnchor"></div>
    </main>

    <!-- INPUT AREA -->
    <footer class="flex-none bg-white dark:bg-surface border-t border-gray-200 dark:border-gray-700 p-4 z-30">
        <div class="max-w-3xl mx-auto relative">
            <div id="commandHints" class="absolute bottom-full left-0 w-full bg-white dark:bg-surface border border-gray-200 dark:border-gray-600 rounded-xl shadow-xl mb-2 hidden overflow-hidden transition-all z-40">
                <div class="p-2 text-xs text-gray-400 font-bold uppercase tracking-wider bg-gray-50 dark:bg-dark">Available Commands</div>
                <div class="max-h-40 overflow-y-auto" id="hintsList"></div>
            </div>

            <div class="flex gap-2 items-end bg-gray-100 dark:bg-dark border border-gray-200 dark:border-gray-600 rounded-2xl p-2 focus-within:ring-2 focus-within:ring-blue-500/50 focus-within:border-blue-500 transition-all shadow-inner relative">
                <textarea 
                    id="userInput" 
                    rows="1" 
                    placeholder="Type @ for commands or ask anything..." 
                    class="flex-1 bg-transparent border-none focus:ring-0 resize-none max-h-32 py-3 px-3 text-base"
                ></textarea>
                
                <button id="micBtn" class="p-3 text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 transition mb-0.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 focus:outline-none" title="Voice Input">
                    <i data-lucide="mic" class="w-5 h-5"></i>
                </button>

                <button id="sendBtn" class="p-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-xl transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed mb-0.5 transform active:scale-95">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="text-center mt-2">
                <p class="text-[10px] text-gray-400">Powered by Open-Meteo, RestCountries, Datamuse, GBIF, & NLP Libs.</p>
            </div>
        </div>
    </footer>

    <style>
        .cmd-btn {
            background-color: rgb(243 244 246);
            border: 1px solid rgb(229 231 235);
            padding: 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dark .cmd-btn {
            background-color: rgb(15 23 42);
            border-color: rgb(75 85 99);
        }
        .cmd-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .mic-active {
            color: #ef4444 !important;
            animation: pulse-fast 1.5s infinite;
            background-color: rgba(239, 68, 68, 0.1) !important;
        }
    </style>

    <script>
        // --- 1. API LAYER ---
        class APIService {
            static async fetchJson(url, options = {}) {
                try {
                    const res = await fetch(url, options);
                    if (!res.ok) throw new Error(`API Error: ${res.status}`);
                    return await res.json();
                } catch (e) {
                    console.error("Fetch failed", e);
                    throw e;
                }
            }

            // --- Knowledge APIs ---

            static async getWikipedia(query) {
                const endpoint = `https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts|pageimages&exintro&explaintext&piprop=thumbnail&pithumbsize=600&titles=${encodeURIComponent(query)}`;
                const data = await this.fetchJson(endpoint);
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                if (pageId === "-1") throw new Error("Article not found.");
                return pages[pageId];
            }

            static async getDefinition(word) {
                const endpoint = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
                const data = await this.fetchJson(endpoint);
                if (!Array.isArray(data)) throw new Error("Word not found.");
                return data[0];
            }

            static async getMath(expression) {
                const endpoint = `https://newton.vercel.app/api/v2/simplify/${encodeURIComponent(expression)}`;
                return await this.fetchJson(endpoint);
            }
            
            static async getCountry(name) {
                // RestCountries
                const data = await this.fetchJson(`https://restcountries.com/v3.1/name/${encodeURIComponent(name)}`);
                return data[0];
            }

            static async getNature(query) {
                // GBIF for Backbone Taxonomy
                const matchData = await this.fetchJson(`https://api.gbif.org/v1/species/match?name=${encodeURIComponent(query)}`);
                if (!matchData.usageKey) throw new Error("Species not found in GBIF.");
                
                // iNaturalist for Photos (better than GBIF usually)
                const obsData = await this.fetchJson(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(query)}`);
                const photo = obsData.results[0]?.default_photo?.medium_url || null;

                return { ...matchData, photo };
            }

            static async getBooks(query) {
                // Internet Archive
                const q = encodeURIComponent(`title:(${query}) AND mediatype:(texts)`);
                const url = `https://archive.org/advancedsearch.php?q=${q}&fl[]=identifier,title,creator,year,description&rows=5&output=json`;
                const data = await this.fetchJson(url);
                return data.response.docs;
            }

            static async checkGrammar(text) {
                // LanguageTool
                const params = new URLSearchParams();
                params.append("text", text);
                params.append("language", "en-US");
                
                const res = await fetch("https://api.languagetool.org/v2/check", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: params
                });
                return await res.json();
            }

            static async getSynonyms(word) {
                // Datamuse
                return await this.fetchJson(`https://api.datamuse.com/words?ml=${encodeURIComponent(word)}&max=10`);
            }
            
            static async getChemistry(query) {
                // PubChem
                const encoded = encodeURIComponent(query);
                const endpoint = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encoded}/property/MolecularFormula,MolecularWeight,IUPACName/JSON`;
                const data = await this.fetchJson(endpoint);
                if (!data.PropertyTable?.Properties?.length) throw new Error("Compound not found.");
                const props = data.PropertyTable.Properties[0];
                const imageUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${props.CID}/PNG?record_type=2d&image_size=300x300`;
                return { ...props, imageUrl };
            }

            static async getWeather(city) {
                // Open-Meteo
                const geo = await this.fetchJson(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`);
                if (!geo.results) throw new Error("City not found.");
                const { latitude, longitude, name, country, country_code } = geo.results[0];
                const weather = await this.fetchJson(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m`);
                return { meta: { name, country, country_code }, data: weather.current };
            }
        }

        // --- 2. LOGIC LAYER ---
        class BotEngine {
            constructor() {
                this.commands = [
                    { 
                        cmd: '@wiki', 
                        desc: 'Search Wikipedia',
                        action: async (query) => {
                            const page = await APIService.getWikipedia(query);
                            let md = `## ${page.title}\n${page.extract}`;
                            if (page.thumbnail) md = `![${page.title}](${page.thumbnail.source})\n\n` + md;
                            md += `\n\n[Read on Wikipedia](https://en.wikipedia.org/?curid=${page.pageid})`;
                            return { type: 'text', content: md };
                        }
                    },
                    {
                        cmd: '@image',
                        desc: 'Generate AI Art (Pollinations)',
                        action: async (prompt) => {
                            const encoded = encodeURIComponent(prompt);
                            const seed = Math.floor(Math.random() * 1000);
                            const url = `https://image.pollinations.ai/prompt/${encoded}?width=1024&height=1024&nologo=true&seed=${seed}`;
                            return { type: 'text', content: `## AI Art: ${prompt}\n![${prompt}](${url})\n[Download High Res](${url})` };
                        }
                    },
                    {
                        cmd: '@math',
                        desc: 'Solve expression',
                        action: async (expr) => {
                            const res = await APIService.getMath(expr);
                            return { type: 'text', content: `## Math Result\n**Input:** \`${res.expression}\`\n**Result:** \`${res.result}\`` };
                        }
                    },
                    {
                        cmd: '@def',
                        desc: 'Dictionary Definition',
                        action: async (word) => {
                            const data = await APIService.getDefinition(word);
                            let md = `## ${data.word}\n`;
                            if(data.phonetics[0]?.text) md += `*${data.phonetics[0].text}*\n\n`;
                            data.meanings.forEach(m => {
                                md += `### ${m.partOfSpeech}\n`;
                                m.definitions.slice(0, 3).forEach((d, i) => {
                                    md += `${i+1}. ${d.definition}\n`;
                                });
                                md += '\n';
                            });
                            return { type: 'text', content: md };
                        }
                    },
                    {
                        cmd: '@country',
                        desc: 'Country Data (RestCountries)',
                        action: async (query) => {
                            const c = await APIService.getCountry(query);
                            const currencies = Object.values(c.currencies).map(x => `${x.name} (${x.symbol})`).join(', ');
                            const langs = Object.values(c.languages).join(', ');
                            
                            let md = `## ${c.name.common} ${c.flag}\n`;
                            md += `![Flag](${c.flags.png})\n\n`;
                            md += `**Capital:** ${c.capital?.[0] || 'N/A'}\n`;
                            md += `**Region:** ${c.region} (${c.subregion})\n`;
                            md += `**Population:** ${c.population.toLocaleString()}\n`;
                            md += `**Languages:** ${langs}\n`;
                            md += `**Currency:** ${currencies}\n`;
                            md += `\n[View on Maps](${c.maps.googleMaps})`;
                            return { type: 'text', content: md };
                        }
                    },
                    {
                        cmd: '@nature',
                        desc: 'Species Info (GBIF/iNat)',
                        action: async (query) => {
                            const d = await APIService.getNature(query);
                            let md = `## ${d.scientificName}\n`;
                            if(d.photo) md += `![Nature](${d.photo})\n\n`;
                            md += `**Common Name:** ${d.canonicalName}\n`;
                            md += `**Kingdom:** ${d.kingdom} | **Phylum:** ${d.phylum}\n`;
                            md += `**Class:** ${d.class} | **Order:** ${d.order}\n`;
                            md += `**Rank:** ${d.rank}\n`;
                            md += `**Status:** ${d.status}\n`;
                            return { type: 'text', content: md };
                        }
                    },
                    {
                        cmd: '@book',
                        desc: 'Search Internet Archive',
                        action: async (query) => {
                            const docs = await APIService.getBooks(query);
                            if(docs.length === 0) return { type: 'text', content: "No texts found in Archive.org." };
                            
                            let md = `## Archive Results for "${query}"\n`;
                            docs.forEach(doc => {
                                const url = `https://archive.org/details/${doc.identifier}`;
                                md += `**[${doc.title || 'Untitled'}](${url})**\n`;
                                md += `*${doc.creator || 'Unknown'} (${doc.year || 'N/A'})*\n\n`;
                            });
                            return { type: 'text', content: md };
                        }
                    },
                    {
                        cmd: '@check',
                        desc: 'Grammar Check (LanguageTool)',
                        action: async (text) => {
                            const res = await APIService.checkGrammar(text);
                            const matches = res.matches;
                            if(matches.length === 0) return { type: 'text', content: "‚úÖ No errors found." };
                            
                            let md = `## Grammar Check\nFound ${matches.length} issues:\n\n`;
                            matches.forEach(m => {
                                md += `**Error:** ${m.message}\n`;
                                md += `*Context:* "...${m.context.text.substring(m.context.offset, m.context.offset + m.context.length)}..."\n`;
                                if(m.replacements.length > 0) md += `*Suggestion:* **${m.replacements.slice(0,3).map(r=>r.value).join(', ')}**\n`;
                                md += `\n`;
                            });
                            return { type: 'text', content: md };
                        }
                    },
                    {
                        cmd: '@word',
                        desc: 'Synonyms (Datamuse)',
                        action: async (word) => {
                            const syns = await APIService.getSynonyms(word);
                            const list = syns.map(s => s.word).join(', ');
                            return { type: 'text', content: `**Synonyms for "${word}":**\n${list}` };
                        }
                    },
                    {
                        cmd: '@analyze',
                        desc: 'NLP Analysis (Compromise.js)',
                        action: async (text) => {
                            const doc = nlp(text);
                            const verbs = doc.verbs().out('array');
                            const nouns = doc.nouns().out('array');
                            const people = doc.people().out('array');
                            const places = doc.places().out('array');
                            
                            let md = `## NLP Analysis\n`;
                            md += `**Sentiment:** ${doc.match('#Nice').found ? 'Positive' : 'Neutral/Negative'}\n`;
                            md += `**Verbs:** ${verbs.join(', ') || 'None'}\n`;
                            md += `**Nouns:** ${nouns.join(', ') || 'None'}\n`;
                            if(people.length) md += `**People:** ${people.join(', ')}\n`;
                            if(places.length) md += `**Places:** ${places.join(', ')}\n`;
                            
                            // RiTa usage for rhyming
                            if(typeof RiTa !== 'undefined') {
                                const lastWord = text.split(' ').pop().replace(/[^\w]/g, '');
                                const rhymes = RiTa.rhymes(lastWord).slice(0,5).join(', ');
                                if(rhymes) md += `\n**Rhymes with "${lastWord}":** ${rhymes}`;
                            }
                            
                            return { type: 'text', content: md };
                        }
                    },
                    {
                        cmd: '@story',
                        desc: 'Generate Story (Tracery)',
                        action: async (genre) => {
                            // Simple Tracery Grammar
                            // Ensure window.tracery is used
                            const t = window.tracery || window.module.exports;
                            if (!t) return { type: 'text', content: "Tracery library failed to load." };
                            
                            const grammar = t.createGrammar({
                                "origin": ["#intro# #middle# #climax# #ending#"],
                                "intro": ["Once upon a time in a #place#, there lived a #hero#.", "In a #adj# #place#, a #hero# woke up."],
                                "middle": ["The #hero# found a #object#.", "A #villain# appeared and stole the #object#."],
                                "climax": ["A battle ensued using #magic#.", "They solved a riddle about #topic#."],
                                "ending": ["The #hero# won and #action#.", "Peace was restored to the #place#."],
                                "place": ["dark forest", "neon city", "cloud kingdom", "underwater dome"],
                                "hero": ["cyber-ninja", "lost wizard", "detective", "talking cat"],
                                "villain": ["shadow king", "glitch", "rogue AI", "dragon"],
                                "object": ["glowing orb", "encrypted key", "ancient sword"],
                                "adj": ["gloomy", "bright", "mysterious"],
                                "magic": ["fireballs", "lasers", "logic bombs"],
                                "topic": ["time travel", "love", "betrayal"],
                                "action": ["celebrated", "slept", "vanished"]
                            });
                            grammar.addModifiers(t.baseEngModifiers);
                            return { type: 'text', content: `## Generative Story\n\n${grammar.flatten('#origin#')}` };
                        }
                    },
                    {
                        cmd: '@chem',
                        desc: 'PubChem Info',
                        action: async (name) => {
                            const d = await APIService.getChemistry(name);
                            let md = `## ${name}\n![Structure](${d.imageUrl})\n**Formula:** ${d.MolecularFormula}\n**Weight:** ${d.MolecularWeight}g/mol\n**IUPAC:** ${d.IUPACName}`;
                            return { type: 'text', content: md };
                        }
                    },
                    {
                        cmd: '@weather',
                        desc: 'Open-Meteo Forecast',
                        action: async (city) => {
                            const d = await APIService.getWeather(city);
                            const codes = { 0:"‚òÄÔ∏è Clear", 1:"üå§Ô∏è Partly Cloudy", 3:"‚òÅÔ∏è Overcast", 45:"üå´Ô∏è Fog", 51:"üåßÔ∏è Drizzle", 61:"üåßÔ∏è Rain", 80:"üå¶Ô∏è Showers", 95:"‚õàÔ∏è Storm" };
                            const cond = codes[d.data.weather_code] || "Unknown";
                            let md = `## ${d.meta.name}, ${d.meta.country}\n**Condition:** ${cond}\n**Temp:** ${d.data.temperature_2m}¬∞C\n**Humidity:** ${d.data.relative_humidity_2m}%\n**Wind:** ${d.data.wind_speed_10m} km/h`;
                            return { type: 'text', content: md };
                        }
                    }
                ];
            }

            getHints() { return this.commands.map(c => ({ cmd: c.cmd, desc: c.desc })); }

            async process(input) {
                const trimmed = input.trim();
                for (const cmdObj of this.commands) {
                    if (trimmed.startsWith(cmdObj.cmd)) {
                        const query = trimmed.substring(cmdObj.cmd.length).trim();
                        if (!query && cmdObj.cmd !== '@story') return { type: 'text', content: `Query required for ${cmdObj.cmd}` };
                        return await cmdObj.action(query);
                    }
                }
                
                // Fallback using Compromise NLP to detect intent
                const doc = nlp(trimmed);
                if(doc.has('weather') && doc.places().found) return this.commands.find(c=>c.cmd==='@weather').action(doc.places().out('text'));
                if(doc.has('define')) return { type: 'text', content: "Use **@word** for synonyms or try our upcoming Dictionary module." };
                
                return { type: 'text', content: "Unknown command. Type **@** to see tools.\nExamples:\n- `@country Japan`\n- `@nature Tiger`\n- `@story`\n- `@analyze [text]`" };
            }
        }

        // --- 3. UI LAYER ---
        class UIManager {
            constructor() {
                this.container = document.getElementById('messagesArea');
                this.loader = document.getElementById('loadingIndicator');
                this.anchor = document.getElementById('scrollAnchor');
                this.themeToggle = document.getElementById('themeToggle');
                this.initTheme();
            }

            initTheme() {
                const isDark = localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
                this.setTheme(isDark);
                this.themeToggle.addEventListener('click', () => {
                    this.setTheme(!document.documentElement.classList.contains('dark'));
                });
            }

            setTheme(isDark) {
                document.documentElement.classList.toggle('dark', isDark);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                lucide.createIcons();
            }

            setLoading(active) {
                this.loader.classList.toggle('hidden', !active);
                this.scrollToBottom();
            }

            scrollToBottom() { this.anchor.scrollIntoView({ behavior: 'smooth' }); }

            sanitize(html) { return DOMPurify.sanitize(html, { ADD_ATTR: ['target'] }); }

            // Actions
            actionCopy(text) {
                const decoded = decodeURIComponent(text);
                navigator.clipboard.writeText(decoded).then(() => alert("Copied!"));
            }

            actionSpeak(text) {
                const decoded = decodeURIComponent(text);
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(decoded);
                    window.speechSynthesis.speak(u);
                }
            }
            
            actionShare(text) {
                const decoded = decodeURIComponent(text);
                if (navigator.share) {
                    navigator.share({ title: 'Anushka AI Response', text: decoded });
                } else {
                    this.actionCopy(text);
                }
            }

            addMessage(role, content, type = 'text') {
                const isUser = role === 'user';
                const div = document.createElement('div');
                div.className = `flex gap-3 w-full animate-slide-up group ${isUser ? 'justify-end' : 'justify-start'}`;
                
                const avatar = isUser 
                    ? `<div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white shadow-md flex-shrink-0"><i data-lucide="user" class="w-4 h-4"></i></div>`
                    : `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-pink-500 to-purple-600 flex items-center justify-center text-white shadow-md flex-shrink-0 text-sm select-none border border-white dark:border-gray-700">üë∏üèª</div>`;

                const contentClass = isUser 
                    ? 'bg-indigo-600 text-white rounded-2xl rounded-tr-none shadow-md' 
                    : 'bg-white dark:bg-surface border border-gray-100 dark:border-gray-700 text-gray-800 dark:text-gray-100 rounded-2xl rounded-tl-none shadow-sm';

                let processed = '';
                let rawText = content;
                if(type === 'text') {
                    processed = `<div class="p-3 px-4 prose dark:prose-invert max-w-none text-sm md:text-base whitespace-pre-wrap">${this.sanitize(marked.parse(content))}</div>`;
                }

                // Toolbar
                const safeText = encodeURIComponent(content.replace(/<[^>]*>?/gm, ''));
                const actionsHtml = `
                    <div class="flex gap-2 mt-1 opacity-0 group-hover:opacity-100 transition-opacity px-1 ${isUser ? 'justify-end' : 'justify-start'}">
                        <button class="p-1 text-gray-400 hover:text-blue-500 transition rounded hover:bg-gray-100 dark:hover:bg-gray-800" onclick="app.ui.actionCopy('${safeText}')" title="Copy">
                            <i data-lucide="copy" class="w-3 h-3"></i>
                        </button>
                        <button class="p-1 text-gray-400 hover:text-blue-500 transition rounded hover:bg-gray-100 dark:hover:bg-gray-800" onclick="app.ui.actionSpeak('${safeText}')" title="Read Aloud">
                            <i data-lucide="volume-2" class="w-3 h-3"></i>
                        </button>
                        ${navigator.share ? `
                        <button class="p-1 text-gray-400 hover:text-blue-500 transition rounded hover:bg-gray-100 dark:hover:bg-gray-800" onclick="app.ui.actionShare('${safeText}')" title="Share">
                            <i data-lucide="share-2" class="w-3 h-3"></i>
                        </button>` : ''}
                    </div>
                `;

                div.innerHTML = isUser 
                    ? `<div class="flex flex-col items-end max-w-[85%]"><div class="${contentClass}">${processed}</div>${actionsHtml}</div>${avatar}`
                    : `${avatar}<div class="flex flex-col items-start max-w-[85%]"><div class="${contentClass}">${processed}</div>${actionsHtml}</div>`;

                this.container.appendChild(div);
                lucide.createIcons();
                this.scrollToBottom();
            }
        }

        // --- 4. INITIALIZATION ---
        class App {
            constructor() {
                this.ui = new UIManager();
                this.bot = new BotEngine();
                this.input = document.getElementById('userInput');
                this.hints = document.getElementById('commandHints');
                this.hintsList = document.getElementById('hintsList');
                this.micBtn = document.getElementById('micBtn');
                
                this.setup();
                this.setupVoice();
            }

            setup() {
                // Generate Hints UI
                this.bot.getHints().forEach(h => {
                    const el = document.createElement('div');
                    el.className = "p-2 px-3 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer border-b border-gray-100 dark:border-gray-700 flex justify-between";
                    el.innerHTML = `<span class="font-mono text-blue-600 font-bold">${h.cmd}</span><span class="text-xs text-gray-500">${h.desc}</span>`;
                    el.onclick = () => this.setInput(h.cmd + ' ');
                    this.hintsList.appendChild(el);
                });

                document.getElementById('sendBtn').onclick = () => this.handleSend();
                document.getElementById('clearHistoryBtn').onclick = () => {
                    document.getElementById('messagesArea').innerHTML = ''; 
                    this.ui.addMessage('bot', 'History cleared.');
                };

                this.input.addEventListener('input', (e) => {
                    this.hints.classList.toggle('hidden', !e.target.value.trim().startsWith('@'));
                });
                
                this.input.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.handleSend(); }
                });
            }

            setupVoice() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.micBtn.style.display = 'none';
                    return;
                }
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.interimResults = false;

                this.recognition.onstart = () => {
                    this.micBtn.classList.add('mic-active');
                };
                this.recognition.onend = () => {
                    this.micBtn.classList.remove('mic-active');
                };
                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    this.input.value += (this.input.value ? ' ' : '') + transcript;
                    this.input.focus();
                };

                this.micBtn.onclick = () => {
                    try {
                        this.recognition.start();
                    } catch(e) {
                        console.error(e);
                        this.recognition.stop();
                    }
                };
            }

            setInput(txt) {
                this.input.value = txt;
                this.input.focus();
                this.hints.classList.add('hidden');
            }

            async handleSend() {
                const txt = this.input.value.trim();
                if(!txt) return;
                this.input.value = '';
                this.hints.classList.add('hidden');
                
                this.ui.addMessage('user', txt);
                this.ui.setLoading(true);

                try {
                    const res = await this.bot.process(txt);
                    this.ui.setLoading(false);
                    this.ui.addMessage('bot', res.content, res.type);
                } catch (e) {
                    this.ui.setLoading(false);
                    this.ui.addMessage('bot', `Error: ${e.message}`);
                }
            }
        }

        window.app = new App();
        lucide.createIcons();
    </script>
</body>
</html>